<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Edge-Cloud RL Dashboard (Model-aware)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{background:#f7fafc}
    .card{border-radius:12px}
    .decision-edge{color:#1f8a5f;font-weight:700}
    .decision-cloud{color:#1864ab;font-weight:700}
    .prog{font-weight:700}
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-3">Edge-Cloud RL â€” Model & Explanation Dashboard</h2>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card p-3">
        <h5>Current Decision</h5>
        <div class="my-3">
          <div id="decision" class="h3">Loading...</div>
          <div id="reason" class="text-muted small"></div>
        </div>

        <h6>Model probabilities</h6>
        <div class="mb-2">
          <div class="d-flex justify-content-between small"><span>EDGE</span><span id="p-edge">-</span></div>
          <div class="progress mb-2"><div id="bar-edge" class="progress-bar" role="progressbar" style="width:0%"></div></div>
          <div class="d-flex justify-content-between small"><span>CLOUD</span><span id="p-cloud">-</span></div>
          <div class="progress"><div id="bar-cloud" class="progress-bar bg-info" role="progressbar" style="width:0%"></div></div>
        </div>
      </div>

      <div class="card p-3 mt-3">
        <h6>Top contributors</h6>
        <ul id="contributors" class="list-group list-group-flush"></ul>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3 mb-3">
        <h6>Realtime metrics</h6>
        <canvas id="metricsChart" height="120"></canvas>
      </div>

      <div class="card p-3">
        <h6>Decision timeline (recent)</h6>
        <div style="max-height:220px; overflow:auto">
          <table class="table table-sm">
            <thead><tr><th>t</th><th>cpu</th><th>mem</th><th>load1</th><th>action</th></tr></thead>
            <tbody id="timeline"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-3 mt-3">
    <h6>Quick explanations</h6>
    <p><b>CPU:</b> percentage of CPU busy time. <b>Memory:</b> percent RAM used. <b>Load1:</b> 1-minute runnable processes average. The "Top contributors" shows the features the surrogate model reports as most influencing the decision.</p>
  </div>
</div>

<script>
const ctx = document.getElementById('metricsChart').getContext('2d');
const metricsChart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[
    {label:'CPU %', data:[], borderColor:'red', fill:false},
    {label:'Memory %', data:[], borderColor:'green', fill:false},
    {label:'Load1', data:[], borderColor:'blue', fill:false}
  ]},
  options:{responsive:true, scales:{x:{display:false}}}
});

async function fetchAll(){
  const [mRes, dRes, tRes] = await Promise.all([
    fetch('/metrics').then(r=>r.json()).catch(()=>({cpu:0,mem:0,load1:0})),
    fetch('/decision').then(r=>r.json()).catch(()=>({decision:'UNKNOWN', model:{probs:{edge:0.5,cloud:0.5}}, explain:{top:[],text:''}})),
    fetch('/timeline').then(r=>r.json()).catch(()=>([]))
  ]);

  // metrics chart
  metricsChart.data.labels.push('');
  metricsChart.data.datasets[0].data.push(mRes.cpu);
  metricsChart.data.datasets[1].data.push(mRes.mem);
  metricsChart.data.datasets[2].data.push(mRes.load1);
  if(metricsChart.data.labels.length>30){
    metricsChart.data.labels.shift();
    metricsChart.data.datasets.forEach(ds=>ds.data.shift());
  }
  metricsChart.update();

  // decision + probs
  document.getElementById('decision').textContent = dRes.decision;
  document.getElementById('reason').textContent = dRes.explain.text || '';

  const pe = (dRes.model.probs.edge*100).toFixed(1), pc=(dRes.model.probs.cloud*100).toFixed(1);
  document.getElementById('p-edge').textContent = pe + '%'; document.getElementById('bar-edge').style.width = pe+'%';
  document.getElementById('p-cloud').textContent = pc + '%'; document.getElementById('bar-cloud').style.width = pc+'%';

  // contributors
  const cont = document.getElementById('contributors'); cont.innerHTML='';
  (dRes.explain.top || []).forEach(it=>{
    const li = document.createElement('li');
    li.className='list-group-item';
    li.innerHTML = `<div class="d-flex justify-content-between"><div><b>${it.feature}</b></div><div class="prog">${(it.score).toFixed(3)}</div></div>`;
    cont.appendChild(li);
  });

  // timeline
  const table = document.getElementById('timeline'); table.innerHTML='';
  (tRes || []).slice(0,50).forEach(row=>{
    const tr = document.createElement('tr');
    const t = new Date(row.t*1000).toLocaleTimeString();
    tr.innerHTML = `<td>${t}</td><td>${row.cpu.toFixed(1)}</td><td>${row.mem.toFixed(1)}</td><td>${row.load1.toFixed(2)}</td><td>${row.action}</td>`;
    table.appendChild(tr);
  });
}

setInterval(fetchAll, 2000);
fetchAll();
</script>
</body>
</html>